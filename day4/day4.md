# day4 

### 创建应用
~~~
# python manage.py startapp day4
# touch day4/urls.py
# tree day4/
day4/
├── admin.py
├── apps.py
├── __init__.py
├── migrations
│?? └── __init__.py
├── models.py
├── tests.py
├── urls.py
└── views.py

1 directory, 8 files
~~~
### 注册app
~~~
# cat day4/apps.py 
from django.apps import AppConfig

class Day4Config(AppConfig):
    name = 'day4'
    
# cat devops/settings.py |grep INSTALLED_APPS -A 9
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'hello.apps.HelloConfig',
    'books.apps.BooksConfig',
    'day4.apps.Day4Config'
~~~
### 设置全局urls
~~~
# cat devops/urls.py  |grep django.contrib  -A 10
urlpatterns = [
#访问batman将url转给hello的urls自己理
    path('hello/',include('hello.urls'),name="hello"),
    path('day4/',include('day4.urls'),name="day4"),
]
~~~

### 建模
~~~
# cat day4/models.py 
from django.db import models

class Day4(models.Model):
    SEX = (
        (0,'男'),
        (1,'女'),
    )
    SKILL = (
        (0,'Python'),
        (1,'Java'),
        (2,'PHP'),
        (3,'C#'),
    )
    name = models.CharField(max_length = 20,help_text='用户名')
    password = models.CharField(max_length=32,help_text="密码")
    tel = models.CharField(max_length=11,help_text="电话")
    email = models.CharField(max_length=35,help_text="邮箱")
    sex = models.IntegerField(choices = SEX,null=True,blank=True)
    skill = models.IntegerField(choices=SKILL, null=True, blank=True)
    def __str__(self):
        return self.name
- 生成迁移脚本     
#  python manage.py makemigrations day4
Migrations for 'day4':
  day4/migrations/0001_initial.py
    - Create model Day4
- 查看生成文件
#  cat day4/migrations/0001_initial.py 
# Generated by Django 2.2 on 2020-04-15 16:26

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Day4',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='用户名', max_length=20)),
                ('password', models.CharField(help_text='密码', max_length=32)),
                ('tel', models.CharField(help_text='电话', max_length=11)),
                ('email', models.CharField(help_text='邮箱', max_length=35)),
                ('sex', models.IntegerField(blank=True, choices=[(0, '男'), (1, '女')], null=True)),
                ('skill', models.IntegerField(blank=True, choices=[(0, 'Python'), (1, 'Java'), (2, 'PHP'), (3, 'C#')], null=True)),
            ],
        ),
    ]
    
-执行语句创建数据库
# python manage.py migrate day4
~~~

### 设计app url
~~~
# cat day4/urls.py 
from django.urls import path,re_path
from day4 import views

app_name = 'day4'
urlpatterns = [
    #查看筛选与添加
    path('index/', views.UserList.as_view(), name='index'),
    #修改
    re_path('daymod/(?P<pk>[0-9]+)?/', views.UserMod.as_view(), name='daymod'),
    #删除
    re_path('daydel/(?P<pk>[0-9]+)?/', views.UserDel.as_view(), name='userdel'),
]
~~~
### 设计对应views
~~~
# cat day4/views.py 
from django.shortcuts import render
from django.shortcuts import reverse
from day4.models import Day4
from django.views.generic import ListView,DeleteView,UpdateView,TemplateView
from django.contrib.messages.views import SuccessMessageMixin
import os
from day4.form import UserForm

#列表筛选与添加
class UserList(SuccessMessageMixin,ListView):
    template_name = 'day4/index.html'
    model = Day4
    context_object_name = 'users'
    success_message = "%(name)s 添加成功！！！"
    #筛选
    def get_queryset(self):
        queryset = super(UserList,self).get_queryset()
        self.keyword = self.request.GET.get("keyword","")
        if self.keyword :
            print(queryset)
            queryset = queryset.filter(name__icontains=self.keyword)
            print(queryset)
        return queryset
    ##添加用户页面跳转
    def get_template_names(self):
        names = super().get_template_names()
        if 'add' in self.request.GET:
            names = ['day4/dayadd.html']
        return names
    ###添加用户
    def post(self, request):
        user_input_obj = UserForm(request.POST)
        print(user_input_obj)
        if user_input_obj.is_valid():
            #验证成功，文件上传
            file = request.FILES.get('file', None)
            if file:
                f = open(os.path.join('upload', file.name), 'wb')
                for line in file.chunks():
                    f.write(line)
                f.close()
        else:
            #验证失败返回验证信息
            form = user_input_obj.errors ##获取错误信息
            print(form)
            return render(request, 'day4/dayadd.html', {'form': form})
        self.html = 'day4/index.html'
        data = request.POST.dict()
        if '_save' in data:
            data.pop('_save')
            Day4.objects.create(**data)
            self.html = 'day4/dayadd.html'
        users = Day4.objects.all()
        return render(request, self.html,{"users": users})
#列表删除
class UserDel(DeleteView):
    model = Day4
    template_name = 'day4/daydel.html'
    def get_success_url(self):
        return reverse('day4:index')

#列表修改
class UserMod(SuccessMessageMixin,UpdateView):
    success_message = "%(name)s 修改成功！！！"
    template_name = 'day4/daymod.html'
    model = Day4
    context_object_name = 'user'
    fields = ('name','password','sex','tel','email','skill')
    def get_success_url(self):
        if 'return' in self.request.POST:
            return reverse('day4:index')
~~~


### 对应html
- index.html
~~~
# cat templates/day4/index.html 
{% extends "base.html" %}

{% block title %} 用户信息 {% endblock %}

{% block content %}

<form method="get"  action="/day4/index/" >
    请输入用户名：
    <input type="text" name="keyword" value="{{object.id}}">
    <button type="submit" value="Submit" >查询 </button>
    <input type="submit" name="add" value="新增" >
</form>
<table border="2">
<thead>
    <tr>
        <th>ID</th>
        <th>用户名</th>
        <th>密码</th>
        <th>性别</th>
        <th>电话</th>
        <th>邮箱</th>
        <th>技能</th>
        <th>编辑</th>
    </tr>
</thead>
<tbody>
    {% for user in users %}
    <tr>
        <td>{{ user.id}} </td>
        <td>{{ user.name }}</td>
        <td>{{ user.password }}</td>
        <td>
            {% if user.sex == 0 %} 男 {% elif user.sex == 1%} 女 {% else %} 未定义 {%endif%}
        </td>
        <td>{{ user.tel}} </td>
        <td>{{ user.email}} </td>
        <td>
        {% if user.skill == 0 %} Python {% elif user.skill == 1%} Java {% elif user.skill == 2 %}PHP {% elif user.skill == 3%} C# {% else %} 未定义 {%endif%}
        </td>

        <td>
            <button><a href="/day4/daymod/{{user.id}}">修改</a></button>
            <button><a href="/day4/daydel/{{user.id}}" >删除</a></button>

        </td>
    </tr>
    {% endfor %}


</tbody>
</table>
~~~
- 添加用户页面
~~~
# cat templates/day4/dayadd.html 
{% extends "base.html" %}

{% block title %} 添加用户 {% endblock %}

{% block content %}

{% if messages %}
<ul>
    {% for message in messages %}
    <li {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{message}}</li>
    {% endfor %}
</ul>
{% endif %}

<form method="post"  action="/day4/index/" enctype="multipart/form-data" >
    姓名:
    <input type="text" name="name" >
    <br>
    {% if form.name %}
    <p style="color: red">{{form.name}}</p>
    {% endif%}
    <br>
    密码:
    <input type="password" name="password">
    <br>
    {% if form.password %}
    <p style="color: red">{{ form.password}}</p>
    {% endif%}
    <br>
    电话:
    <input type="text" name="tel">
    {% if form.tel %}
    <p style="color: red">{{ form.tel}}</p>
    {% endif%}
    <br>
    <br>
    邮箱:
    <input type="text" name="email">
    {% if form.email %}
    <p style="color: red">{{ form.email}}</p>
    {% endif%}
    <br>
    <br>
    性别:
    <input type="radio" name="sex" value="0" checked>男
    <input type="radio" name="sex" value="1">女
    <br>
    <br>
    技能:
    <select name="skill">
        <option value="0" selected>Python</option>
        <option value="1" >Java</option>
        <option value="2" >PHP</option>
        <option value="3">C#</option>
    </select>
    <br>
    <br>
     添加附件:
    <input type="file" name="file" >
    {% if form.file %}
    <p style="color: red">{{ form.file}}</p>
    {% endif%}
    <br>
    <input type="submit" value="保存" name="_save">
    <button> <a href="/day4/index/" >返回</a> </button>
</form>



{% endblock %}
~~~

- 修改页面
~~~
# cat templates/day4/daymod.html 
{% extends "base.html" %}

{% block title %} 修改用户信息 {% endblock %}

{% block content %}

{% if messages %}
<ul>
    {% for message in messages %}
    <li {% if message.tags %} class="{{ message.tags }}"{% endif %}>{{message}}</li>
    {% endfor %}
</ul>
{% endif %}

{% if form %}
<ul>
    {{form.errors}}
</ul>
{% endif %}

<form method="post"><br>
ID：<br>
<input type="text" name='id' value={{user.id}} readonly="readonly">
    <br>
用户名：<br>
<input type="text" name = 'name' value={{user.name}} >
    {% if form.name %}
    <p style="color: red">{{ form.name.errors}}</p>
    {% endif%}
密码:<br>
<input type="text" name="password" value={{user.password}}>
    {% if form.password %}
    <p style="color: red">{{ form.password.errors}}</p>
    {% endif%}
电话:<br>
<input type="text" name="tel" value={{user.tel}}>
    {% if form.tel %}
    <p style="color: red">{{ form.tel.errors}}</p>
    {% endif%}
邮箱:<br>
<input type="text" name="email" value={{user.email}}>
    {% if form.email %}
    <p style="color: red">{{ form.email.errors}}</p>
    {% endif%}
性别:<br>
    <input type="radio" name="sex" value="0" checked>男
    <input type="radio" name="sex" value="1">女
    <br>
技能:<br>
    <input type="radio" name="skill" value="0" checked>Python
    <input type="radio" name="skill" value="1">PHP
    <input type="radio" name="skill" value="2">Java
    <input type="radio" name="skill" value="3">C#
<br><br>
    <input type="submit" value="修改" >
    <input type="submit" value="返回" name="return" >
</form>
{% endblock %}
~~~

- 删除页面
- 
~~~
# cat templates/day4/daydel.html 
{% extends "base.html" %}

{% block title %} 确认删除用户 {% endblock %}

{% block content %}


<table border="1" >
<thead>
    <tr>
        <th>ID</th>
        <th>用户名</th>
        <th>密码</th>
        <th>性别</th>
    </tr>
</thead>
<tbody>
<tr>
    <td>{{ object.id}} </td>
    <td>{{ object.name }}</td>
    <td>{{ object.password }}</td>
    <td>
        {% if object.sex == 0 %} 男 {% elif object.sex == 1%} 女 {% else %} 未定义 {%endif%}
    </td>
</tr>
</tbody>
</table>
<form  method="post" >
    <button type="submit">确定 </button>
    <button> <a href="/day4/index/" >返回</a> </button>
</form>

{% endblock %}

~~~
- 错误输出文件
- 
~~~
# cat day4/form.py 
from django import forms
from day4.models import Day4

class UserForm(forms.Form):
    #定义最大最小值，默认不允许为空
    name = forms.CharField(max_length=10)
    password = forms.CharField(min_length=6,required=True)
    tel = forms.CharField(max_length=11,min_length=11,required=True)
    email = forms.CharField(max_length=32,required=True)
    file = forms.FileField(required=False)

    def clean_info(self):
        info = self.changed_data['info']
        print(info.split())
        num_info = len(info.split())
        if num_info <4 :
            raise forms.ValidationError('Info not enough words!')
        return info

~~~

### 界面演示
![筛选](G:\python实战\python实战\day4\筛选.png)
![修改](G:\python实战\python实战\day4\修改.png)
![添加](G:\python实战\python实战\day4\添加.png)













