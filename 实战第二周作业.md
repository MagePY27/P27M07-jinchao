# 打通MTV，实现界面增删改

- 一、数据库建模
   - 1.建立一个简单的用户表
~~~
# cat hello/models.py 
from django.db import models

class User(models.Model):
    SEX = (
        ('0','男'),
        ('1','女'),
    )
    name = models.CharField(max_length = 20,help_text='用户名')
    password = models.CharField(max_length=32,help_text="密码")
    sex = models.IntegerField(choices = SEX,null=True,blank=True)
    def __str__(self):
        return self.name

~~~
   - 生成数据表
~~~
――――生成迁移脚本
# python manage.py makemigrations hello

――――查看生成文件
# cat hello/migrations/0001_initial.py
# Generated by Django 2.2 on 2020-03-31 18:37

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(help_text='用户名', max_length=20)),
                ('password', models.CharField(help_text='密码', max_length=32)),
                ('sex', models.IntegerField(blank=True, choices=[('0', '男'), ('1', '女')], null=True)),
            ],
        ),
    ]

――――展示迁移的sql语句
# python manage.py sqlmigrate hello 0001
BEGIN;
--
-- Create model User
--
CREATE TABLE `hello_user` (`id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY, `name` varchar(20) NOT NULL, `password` varchar(32) NOT NULL, `sex` integer NULL);
COMMIT;


――――执行数据库命令
# python manage.py migrate hello


――――进入数据库查看数据表
MariaDB [(none)]> use devops;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [devops]> show tables;
+----------------------------+
| Tables_in_devops           |
+----------------------------+
| auth_group                 |
| auth_group_permissions     |
| auth_permission            |
| auth_user                  |
| auth_user_groups           |
| auth_user_user_permissions |
| django_admin_log           |
| django_content_type        |
| django_migrations          |
| django_session             |
| hello_user                 |
+----------------------------+
11 rows in set (0.00 sec)

~~~
   - 设计url
	1. 设计全局url 当用户访问Batman时转到app应用自身处理
~~~
# cat devops/urls.py

from django.contrib import admin
from django.urls import path,re_path
from django.urls import path,include

urlpatterns = [
#访问batman将url转给hello的urls自己理
    path('batman/',include('hello.urls')),
    path('admin/', admin.site.urls),
]
~~~

   - 设计app的url
~~~
# cat hello/urls.py 
from django.urls import path,re_path
from . import views

app_name = 'hello'
urlpatterns = [
#访问列表url
    path('list/',views.list,name='list'),
#删除数据时调用userdel函数
    re_path('userdel/([0-9]{1,3})',views.userdel,name='userdel'),
#修改时转到修改界面
    re_path('usermod/([0-9]{1,3})',views.usermod,name='usermod'),
#修改完成后，对数据库进行操作
    re_path('usermod/usermod_ok',views.usermod_ok,name='usermod_ok'),
#新增时转入新增界面
    path('usernew/', views.usernew, name='usernew'),
#新增数据完成后，对数据库进行操作
    re_path('usernew/usernew_ok', views.usernew_ok, name='usernew_ok'),
]
~~~
   - 设计对应views 函数
~~~
# cat  hello/views.py 
from django.shortcuts import render
#导入http模版，前端显示格式
from django.http import HttpResponse,QueryDict
from django.shortcuts import render
from hello.models import User


#接收到用户访问请求 把数据库数据传到对应的初始列表html文件
def list(request):
    users = User.objects.all()
    return render(request, 'hello/userlist.html', {"users": users})

#接收到用户新增请求 转收集数据的usernew的html文件
def usernew(request):
    return render(request, 'hello/usernew.html')
#接受到用户新增的数据，将其同步到数据库 并返回到初始页面
def usernew_ok(request):
    if request.method == 'POST':
        add = request.POST.dict()
        User.objects.create(**add)
    users = User.objects.all()
    return render(request, 'hello/userlist.html', {"users": users})

#接受到用户删除指令时删除相关数据并返回初始界面（这里想做成弹框确认，还未掌握相关html知识）
def userdel(request,udel):
    User.objects.get(id=udel).delete()
    users = User.objects.all()
    return render(request, 'hello/userlist.html', {"users": users})

#接收到用户修改请求后 转到收集修改信息界面
def usermod(request,umod):
    user = User.objects.get(id=umod);
    return render(request, 'hello/usermod.html', {"user": user})
#接收到用户确认修改请求后 对数据库进行同步 并返回初始界面
def usermod_ok(request):
    if request.method == 'POST':
        postget = request.POST.dict()
#        print(postget)
#        print(request.POST)
        User.objects.filter(id=request.POST.get('id')).update(**postget)
    users = User.objects.all()
    return render(request, 'hello/userlist.html', {"users": users})

~~~
### 设计对应的html文件
1. 初始界面 显示数据库信息 并将sex 0 1 与男女对应 并对增删改做对应处理
~~~
# cat templates/hello/userlist.html 
{% extends "base.html" %}

{% block title %} 用户信息 {% endblock %}

{% block content %}
<table border="1">
<thead>
    <tr>
        <th>用户名</th>
        <th>密码</th>
        <th>性别</th>
        <th>编辑</th>
    </tr>
</thead>
<tbody>
    {% for user in users %}
    <tr>
        <td>{{ user.name }}</td>
        <td>{{ user.password }}</td>
        <td>
                    {% if user.sex == 0 %}
                            男
                    {%endif%}
                    {% if user.sex == 1%}
                            女
                    {%endif%}
        </td>
        <td>
            <a href="/batman/usermod/{{user.id}}">修改</a>
            <a href="/batman/userdel/{{user.id}}">删除</a>
             <a href="/batman/usernew/">新增</a>
                </td>
    </tr>
    {% endfor %}
</tbody>
</table>
{% endblock %}

~~~
2. 增加用户页面 并将相关数据通过 action="usernew_ok" 传回url
~~~
# cat templates/hello/usernew.html 
{% extends "base.html" %}

{% block title %} 新增用户 {% endblock %}

{% block content %}

<form action="usernew_ok" method="post"  >
用户名：<br>
<input type="text" name = 'name' value={{user.name}} >
<br>
密码:<br>
<input type="text" name="password" value={{user.password}}>
 <br>
性别:<br>
<input type="text" name="sex" value={{user.sex}}>
<br><br>
    <input type="submit" value="确认" >
</form>
{% endblock %}
~~~
3. 修改用户页面 显示用户id 但是用户id不能修改 并通过 action="usermod_ok" 传回相关数据
~~~
# cat templates/hello/usermod.html 
{% extends "base.html" %}

{% block title %} 修改用户信息 {% endblock %}

{% block content %}

<form action="usermod_ok" method="post"  ><br>
ID：<br>
<input type="text" name='id' value={{user.id}} readonly="readonly">
    <br>
用户名：<br>
<input type="text" name = 'name' value={{user.name}} >
<br>
密码:<br>
<input type="text" name="password" value={{user.password}}>
 <br>
性别:<br>
<input type="text" name="sex" value={{user.sex}}>
<br><br>
    <input type="submit" value="确认" >
</form>
{% endblock %}
~~~ 




